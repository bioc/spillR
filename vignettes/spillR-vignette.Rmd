---
title: "spillR workflow"
author:
  name: Marco Guazzini
  affiliation: Department of Advanced Computing Sciences, Maastricht University
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{spillR-vignette}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
bibliography: spillr_paper.bib
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE, 
                      fig.retina = 2, dpi = 96, 
                      fig.width = 7.2916667, fig.asp = 0.6178571
                      )
```

# Introduction
Mass cytometry makes it possible to count a large number of proteins 
simultaneously on individual cells [@bandura2009mass; @bendall2011single]. 
Mass cytometry has less spillover--- measurements from one channel overlap less 
with those of another---than flow cytometry [@sp-c; @novo2013generalized], 
but spillover is still a problem and affects downstream analyses such as 
differential testing [@diffcyt; @seiler2021cytoglmm] or 
dimensionality reduction [@scater]. 
Reducing spillover by careful design of experiment 
is possible [@takahashi2017mass], but a purely experimental approach may not be 
sufficient nor efficient [@lun2017influence].
@catalyst propose a method for addressing spillover by conducting an 
experiment on beads. 
This experiment measures spillover by staining each bead with a single antibody.
Their solution relies on an estimate for the spillover matrix using 
non-negative matrix factorization. The spillover matrix encodes the pairwise 
spillover proportion between channels. 
We avoid this step and directly describe the spillover channels and 
the channel with the true signal using a mixture of nonparametric distributions.
Our main new assumption is that the spillover distribution---not just the 
spillover proportion---from the bead experiment
carries over to the biological experiment.
Here, we illustrate `spillR`

```{r, warning=FALSE}
library(spillR)
library(CATALYST)
library(dplyr)
library(cowplot)
bc_key <- c(139, 141:156, 158:176)
sce_bead <- prepData(ss_exp)
sce_bead <- assignPrelim(sce_bead, bc_key, verbose = FALSE)
sce_bead <- applyCutoffs(estCutoffs(sce_bead))
sce_bead <- computeSpillmat(sce_bead)

# --------- experiment with real cells ---------
data(mp_cells, package = "CATALYST")
sce <- prepData(mp_cells)

# --------- table for mapping markers and barcode ---------
marker_to_barc <- 
    rowData(sce_bead)[,c("channel_name", "is_bc")] %>%
    as_tibble %>%
    dplyr::filter(is_bc == TRUE) %>%
    mutate(barcode=bc_key) %>%
    select(marker=channel_name, barcode)

# --------- call compensate from compCytof package ---------
sce_spillr <- 
    spillR::compCytof(sce, sce_bead, marker_to_barc, overwrite=FALSE)

# --------- 2d histogram from spillR (for vignette, not for paper) -------
as <- c("counts", "exprs", "compcounts", "compexprs")
chs <- c( "Yb171Di", "Yb173Di")
ps <- lapply(as, function(a) 
    plotScatter(sce_spillr, chs, assay=a))
plot_grid(plotlist = ps, nrow=2)
# --------- plot with spillR ---------
spillR::plotDiagnostics(sce_spillr, "Yb173Di")

```
# Session Info {.unnumbered}

```{r session_info}
sessionInfo()
```
